<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Echo Project</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header>
    <h1>Personal Gallery</h1>
    <nav>
      <a href="/">Home</a>
      <a href="about.html">About</a>
    </nav>
  </header>

  <main>
    <section class="form-section">
      <form id="uploadForm">
        <label for="img">Image: </label>
        <input type="file" name="image" id="img" accept=".png" />

        <input type="submit" value="Upload" />
      </form>
    </section>

    <section class="resize-section" style="display: none">
      <form id="resizeForm">
        <label for="width">Width:</label>
        <input type="number" name="width" id="width" required />
        <label for="height">Height:</label>
        <input type="number" name="height" id="height" required />
        <input type="submit" value="Resize" />
      </form>
    </section>

    <section class="gallery-section">
      <h2>Gallery</h2>
      <div class="gallery" id="gallery"></div>
    </section>
  </main>

  <script>
    let selectedImage = null;

    // Load images from server
    async function loadGallery() {
      const res = await fetch('/uploads'); // not an API, just accessing statics
      const files = await fetch('/uploads').then(() => {
        // simulate known filenames (you could build an endpoint to list them)
        return [
          'HOW%20DOES%20SHE%20KNOW.png',
          'akuma%20in%20squiggam-1746166244621.png'
        ];
      });

      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      files.forEach(file => {
        const img = document.createElement('img');
        img.src = `/uploads/${file}`;
        img.alt = file;
        img.classList.add('gallery-image');
        img.style.cursor = 'pointer';

        img.addEventListener('click', () => {
          selectedImage = file;
          document.querySelector('.resize-section').style.display = 'block';
        });

        const card = document.createElement('div');
        card.classList.add('card');
        card.appendChild(img);
        gallery.appendChild(card);
      });
    }

    // Upload form
    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fileInput = document.getElementById('img');
      const file = fileInput.files[0];
      if (!file || file.type !== 'image/png') return alert('Only PNG allowed');

      const fd = new FormData();
      fd.append('image', file);

      try {
        const res = await fetch('/images/upload', {
          method: 'POST',
          body: fd
        });
        if (!res.ok) throw new Error('Upload failed');

        alert('Upload successful');
        fileInput.value = '';
        loadGallery();
      } catch (err) {
        alert('Error during upload');
        console.error(err);
      }
    });

    // Resize form
    document.getElementById('resizeForm').addEventListener('submit', async e => {
      e.preventDefault();
      if (!selectedImage) return alert('Select an image first');

      const width = document.getElementById('width').value;
      const height = document.getElementById('height').value;

      const fd = new FormData();
      fd.append('image', await fetch(`/uploads/${selectedImage}`).then(r => r.blob()));
      fd.append('width', width);
      fd.append('height', height);

      try {
        const res = await fetch('/api/images/upload-resize', {
          method: 'POST',
          body: fd
        });
        if (!res.ok) throw new Error('Resize failed');

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      } catch (err) {
        alert('Resize failed');
        console.error(err);
      }
    });

    loadGallery();
  </script>
</body>
</html>
